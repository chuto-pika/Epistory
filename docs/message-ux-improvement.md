# メッセージ先生 UX改善計画

## 背景

メッセージ先生を実際に使ってみた結果、以下の問題が判明した:

- 宛名が「お父さん・お母さん」のように固定で、結局編集が必要
- エピソード（Step 4）がそのまま差し込まれるだけで不自然
- Step 6がP.S.になることが生成後まで分からない
- 文章の繋ぎが機械的で使えるレベルではない
- 単一選択で毎回「次へ進む」を押すのが面倒

## 改善Issue一覧

| # | タイトル | Phase | 種別 | 依存 |
|---|---------|-------|------|------|
| 53 | 単一選択ステップの自動遷移 | 1 | フロントエンド | なし |
| 54 | 宛名の改善（二段階選択） | 2 | フルスタック | なし |
| 55 | テンプレート文章の改善 | 3 | バックエンド | なし |
| 56 | Step 6のPS改善 | 4 | フロントエンド | なし |
| 57 | AI生成によるハイブリッド方式 | 5 | バックエンド | #55 |

各Phaseは独立してデプロイ可能（#57のみ#55に依存）。

---

## Issue #53: 単一選択ステップの自動遷移（Step 2, 5）

### 概要

ラジオボタン選択時に300ms後に自動でフォーム送信し、「次へ進む」ボタンを押す手間を省く。

### 対象ステップ

- **Step 2**（きっかけ選択）: ラジオボタン → 自動遷移
- **Step 5**（気持ち選択）: ラジオボタン → 自動遷移
- Step 1は宛名入力が追加されるため対象外（Issue #54で対応）
- Step 3は複数選択のため対象外

### やること

- [ ] `app/javascript/controllers/auto_advance_controller.js` を新規作成
- [ ] `app/views/messages/_selection_card.html.erb` に `data-action` 属性を条件付き追加
- [ ] `app/views/messages/step2.html.erb` のフォームに `data-controller="auto-advance"` 追加
- [ ] `app/views/messages/step5.html.erb` に同上

### auto_advance_controller.js の仕様

- radioの `change` イベントで発火
- 300msのdelayの後、`form.requestSubmit()` で送信
- 「次へ進む」ボタンはJS無効時のフォールバックとして残す

### 完了条件

- Step 2でカード選択後、300ms後に自動的にStep 3へ遷移する
- Step 5でカード選択後、300ms後に自動的にStep 6へ遷移する
- JS無効時は従来通り「次へ進む」ボタンで遷移できる
- モバイルのタッチイベントでも正しく動作する

### 依存Issue

- なし

---

## Issue #54: 宛名の改善（Step 1を二段階選択に）

### 概要

カテゴリ選択後に、具体的な宛名を選択or自由入力できるようにする。

### UXフロー

1. カテゴリカード（親、パートナー等）をクリック
2. カードが選択状態になり、下部に宛名入力セクションがスライド表示
3. よくある呼び方のチップ（例: 親→「お父さん」「お母さん」「両親」）を表示
4. チップクリック or テキスト入力で宛名を決定
5. チップクリック時は自動送信、テキスト入力時は「次へ進む」で送信
6. 宛名を入力しなくても進める（その場合は従来のHONORIFICS使用）

### 宛名チップのデータ（ビューにハードコード）

```ruby
{
  "親" => ["お父さん", "お母さん", "両親"],
  "パートナー" => ["あなた"],
  "友人" => [],
  "兄弟・姉妹" => ["お兄ちゃん", "お姉ちゃん", "弟", "妹"],
  "祖父母" => ["おじいちゃん", "おばあちゃん"],
  "職場の人" => [],
  "その他" => []
}
```

空の場合はチップ不要で自由入力のみ表示。

### やること

- [ ] `db/migrate/XXXXXX_add_recipient_name_to_messages.rb` 作成（`recipient_name` string, nullable）
- [ ] `app/javascript/controllers/recipient_name_controller.js` 新規作成
- [ ] `app/views/messages/step1.html.erb` 二段階UI実装
- [ ] `app/controllers/messages_controller.rb` の `save_step1` で `recipient_name` を保存
- [ ] `app/controllers/concerns/message_draft.rb` の `build_message_from_draft` に `recipient_name` 追加
- [ ] `app/services/message_generator.rb` の `opening` メソッドで `recipient_name` を優先使用

### 完了条件

- カテゴリ選択後に宛名入力セクションが表示される
- チップクリックで宛名が入力され自動送信される
- テキスト入力で自由な宛名を指定できる
- 宛名未入力でも従来通り進める
- 生成メッセージの宛名に `recipient_name` が反映される

### 依存Issue

- なし

---

## Issue #55: テンプレート文章の改善

### 概要

エピソードの繋ぎと印象描写を改善し、テンプレートベースでも自然な文章を生成する。

### やること

- [ ] `app/services/message_generator.rb` にエピソード導入・接続文を追加

### エピソードの繋ぎ

`episode_section` メソッドで、Step 4テキストの前後に導入・接続文を追加:

```ruby
EPISODE_INTROS = [
  "思い出すのは、",
  "ふと思い出すのは、",
].freeze

EPISODE_OUTROS = [
  "あのときのことは、今でも忘れません。",
  "そのことを思い出すたびに、温かい気持ちになります。",
].freeze
```

`"#{intro}#{episode}\n#{outro}"` の形でエピソードを自然に接続する。

### 印象セクションの改善

現在の「〇〇、そして△△。そんな存在です。」を、印象ごとに個別の描写テンプレートで自然にする。

### 完了条件

- エピソードが導入文・接続文と自然に繋がる
- 印象が具体的な描写文として表現される
- 既存のユニットテストを更新して通る

### 依存Issue

- なし

---

## Issue #56: Step 6のPS改善

### 概要

Step 6の入力がP.S.として使われることをユーザーに明示し、よくあるPS候補をチップとして提供する。

### UI構成

1. 「ここに入力した内容は **P.S.** として追加されます」の説明文をTextareaの上に表示
2. よくあるPS候補をチップとして表示:
   - 「今度一緒にごはん行こうね」
   - 「体に気をつけてね」
   - 「また会えるのを楽しみにしてるよ」
   - 「いつでも連絡してね」
   - 「無理しないでね」
3. チップクリック → textareaに内容を挿入（char-counterのinputイベントも発火）
4. 自由入力も引き続き可能

### やること

- [ ] `app/javascript/controllers/ps_suggestion_controller.js` 新規作成
- [ ] `app/views/messages/step6.html.erb` にPS説明ラベル追加
- [ ] `app/views/messages/step6.html.erb` にPS候補チップ追加

### 完了条件

- Textareaの上に「P.S.として追加されます」の説明が表示される
- PS候補チップが表示される
- チップクリックでtextareaに内容が挿入される
- 文字数カウンターが正しく連動する
- 自由入力も引き続き可能

### 依存Issue

- なし

---

## Issue #57: AI生成によるハイブリッド方式

### 概要

基本構造はテンプレートで組み立て、繋ぎ部分やエピソードの自然な統合をAI（OpenAI API）で行う。

### 動作フロー

1. まず `MessageGenerator` でテンプレートメッセージを生成
2. `AiMessageGenerator` がそのテンプレートをOpenAI APIに渡し、自然な文章に書き直し
3. APIキー未設定/エラー時はテンプレート結果をそのまま使用（フォールバック）
4. APIキーはRails credentialsに格納

### AIプロンプトの方針

- 元のメッセージの意味・構成を維持
- 呼称（宛名）はそのまま
- エピソードの内容は変えずに前後と自然に接続
- P.S.はそのまま残す
- 500文字以内

### やること

- [ ] `Gemfile` に `ruby-openai` gem追加
- [ ] `app/services/ai_message_generator.rb` 新規作成
- [ ] `app/controllers/concerns/message_draft.rb` の `create_message_from_draft` でAI生成を呼び出し
- [ ] APIキー未設定時のフォールバック動作確認
- [ ] エラー時のフォールバック動作確認

### 完了条件

- テンプレート→AI書き直しの流れでメッセージが生成される
- APIキー未設定時はテンプレート結果がそのまま使用される
- API呼び出しエラー時もテンプレート結果にフォールバックする
- 生成メッセージが500文字以内に収まる

### 依存Issue

- #55 テンプレート文章の改善

---

## 実装順序

```
Phase 1: #53 自動遷移        ← バックエンド変更なし、リスク低
Phase 2: #54 宛名改善        ← マイグレーション+Stimulus+ビュー+サービス
Phase 3: #55 テンプレート改善 ← サービスのみの変更
Phase 4: #56 PS改善          ← フロントエンドのみ
Phase 5: #57 AI生成          ← gem追加+新サービス+既存フロー統合
```

## 依存関係図

```
#53 自動遷移         ← 独立
#54 宛名改善         ← 独立
#55 テンプレート改善  ← 独立
#56 PS改善           ← 独立
#57 AI生成           ← #55
```

## 検証方法

- 各Phase完了後にローカルで手動テスト（ウィザード全ステップ通し）
- 既存のシステムテスト/コントローラーテストの更新
- AI生成はAPIキー未設定時のフォールバック動作を確認
- モバイルでの自動遷移の動作確認（タッチイベント）
